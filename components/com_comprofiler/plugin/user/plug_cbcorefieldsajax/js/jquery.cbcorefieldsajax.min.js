(function(e){var t=[];var i={};var n={init:function(n){return this.each(function(){var f=this;var o=e(f).data("cbajaxfield");if(o){return}o={};o.options=n;o.defaults=e.fn.cbajaxfield.defaults;o.settings=e.extend(true,{},o.defaults,o.options);o.element=e(f);if(o.settings.useData){e.each(o.defaults,function(e,t){if(e!="init"&&e!="useData"){var i=o.element.data("cbajaxfield"+e.charAt(0).toUpperCase()+e.slice(1));if(typeof i!="undefined"){o.settings[e]=i}else{i=o.element.data("cbajaxfield"+e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());if(typeof i!="undefined"){o.settings[e]=i}}}})}o.element.trigger("cbajaxfield.init.before",[o]);if(!o.settings.init){return}e.ajaxPrefilter(function(e,t,i){e.async=true});if(o.settings.mode=="update"){if(!(o.settings.selectors||e(o.settings.selectors).length)){return}if(o.settings.post===null||typeof o.settings.post!="object"&&!e.isArray(o.settings.post)){o.settings.post={}}o.timer=null;o.changeHandler=function(t){if(typeof t.data.ajaxUpdateTarget=="undefined"){return}var n=o.settings.post;var a=e(this).attr("name");var f=s.call(t.data.ajaxUpdateTarget);if(!a.length){return}n[a]=f;var d=l.call(o.element);if(d.length){var u=d.attr("name");var p=s.call(d);if(u.length){n[u]=p}}var m=o.element.find(".cb_field > div:first,.cb_field > span:first,.fieldCell");if(!m.length){m=o.element}var b=400;if(t.type=="keyup"){b=800}if(o.timer){clearTimeout(o.timer)}o.timer=setTimeout(function(){if(o.element.hasClass("cbAjaxUpdating")){return}if(typeof i[a]!="undefined"){var t=e.isArray(i[a])?i[a].toString():i[a];var l=e.isArray(f)?f.toString():f;if(t===l){return}}i[a]=f;e.ajax({url:o.settings.url,type:"POST",dataType:"html",cache:false,data:n,beforeSend:function(e,t,i){o.element.addClass("cbAjaxUpdating");o.element.find(".cbAjaxUpdate").remove();if(!d.length){m.append('<span class="cbFieldIcons cbAjaxUpdate"><span class="cbSpinner fa fa-spinner fa-spin-fast"></span></span>')}else{d.after('<span class="cbFieldIcons cbAjaxUpdate"><span class="cbSpinner fa fa-spinner fa-spin-fast"></span></span>')}o.element.triggerHandler("cbajaxfield.update.send",[o,e,t,i])},error:function(e,t,i){o.element.removeClass("cbAjaxUpdating");o.element.find(".cbAjaxUpdate").remove();o.element.triggerHandler("cbajaxfield.update.error",[o,e,t,i])},success:function(t,i,n){o.element.removeClass("cbAjaxUpdating");o.element.find(".cbAjaxUpdate").remove();var a=e("<div />").html(t);var l=r.call(a);o.element.removeClass("cbValidationError has-error");o.element.find(".cbValidationMessage").remove();m.html(a.html());o.element.triggerHandler("rebind");o.element.find("select,input,textarea").removeClass(".cbValidationError").triggerHandler("change");c.call(o.element,l);if(e.fn.cbtooltip){o.element.find('.cbTooltip,[data-hascbtooltip="true"]').cbtooltip()}o.element.triggerHandler("cbajaxfield.update.success",[o,t,i,n])}})},b)};e(o.settings.selectors).each(function(){var t=l.call(this);if(!t.length){return true}var n=t.attr("name");if(n.length){i[n]=s.call(t)}t.on("keyup change",{ajaxUpdateTarget:t},o.changeHandler);e(this).on("rebind.cbajaxfield",function(){t.off("keyup change",{ajaxUpdateTarget:t},o.changeHandler);t=l.call(this);if(!t.length){return}t.on("keyup change",{ajaxUpdateTarget:t},o.changeHandler)})})}else{o.editHandler=function(t){if(!o.element.hasClass("cbAjaxEditing")&&(!o.settings.ignore||o.settings.ignore&&!e(t.target).is(o.settings.ignore)&&!e(t.target).parents().is(o.settings.ignore))){o.element.addClass("cbAjaxEditing");var i=o.settings.url;if(!i){i=e(this).attr("href")}var n=o.element.innerWidth();if(n<300){n=400}var a=o.settings.mode!="tooltip"&&o.settings.mode!="modal"||!e.fn.cbtooltip?"inline":o.settings.mode;e.ajax({url:i,type:"GET",dataType:"html",cache:false,beforeSend:function(t,i,n){e(document).find(".cbAjaxCancel").click();o.element.append('<span class="cbSpinner fa fa-spinner fa-spin-fast"></span>');if(a=="inline"){o.element.find(".cbAjaxValue").addClass("hidden")}o.element.triggerHandler("cbajaxfield.edit.send",[o,t,i,n])},error:function(e,t,i){o.element.removeClass("cbAjaxEditing");o.element.find(".cbAjaxForm,.cbSpinner").remove();if(a=="inline"){o.element.find(".cbAjaxValue").removeClass("hidden")}o.element.triggerHandler("cbajaxfield.edit.error",[o,e,t,i])},success:function(i,l,s){o.element.find(".cbSpinner").remove();if(a=="inline"){o.element.find(".cbAjaxValue").removeClass("hidden")}var f=e(i);var d=r.call(f);var u=null;if(a=="inline"){o.element.addClass("hidden");o.element.after(f)}else if(a=="tooltip"){u=e("<div />").cbtooltip({tooltip:f,openReady:true,positionMy:"top left",positionAt:"top left",positionTarget:o.element,adjustMethod:"none",openEvent:"none",closeEvent:"none",dialog:true,buttonClose:false,width:n,height:"auto",classes:(e.fn.cbtooltip.defaults.classes?e.fn.cbtooltip.defaults.classes:"")+(o.settings.classes?" "+o.settings.classes:"")+" cbAjaxTooltip"});f=u.qtip("api").elements.content}else if(a=="modal"){u=e("<div />").cbtooltip({tooltip:f,openReady:true,openEvent:"none",closeEvent:"none",modal:true,dialog:true,buttonClose:false,width:n,height:"auto",classes:(e.fn.cbtooltip.defaults.classes?e.fn.cbtooltip.defaults.classes:"")+(o.settings.classes?" "+o.settings.classes:"")+" cbAjaxModal"});f=u.qtip("api").elements.content;f.find("input,select,textarea").on("change",function(){if(u){u.cbtooltip("reposition");if(u){setTimeout(function(){if(u){u.cbtooltip("reposition");setTimeout(function(){if(u){u.cbtooltip("reposition")}},200)}},600)}}})}c.call(f,d);if(e.fn.cbtooltip){f.find('.cbTooltip,[data-hascbtooltip="true"]').cbtooltip()}if(u){u.on("cbtooltip.hidden",function(){o.element.removeClass("cbAjaxEditing");u=null;o.element.trigger("cbajaxfield.cancel",[o,t])})}else{f.find(".cbAjaxCancel").on("click",function(e){o.element.removeClass("cbAjaxEditing");if(a=="inline"){f.remove();o.element.find(".cbSpinner").remove();o.element.removeClass("hidden")}else if(u){u.qtip("api").toggle(false);u=null}o.element.trigger("cbajaxfield.cancel",[o,e])})}f.find(".cbAjaxForm").on("submit",function(t){t.preventDefault();e(this).ajaxSubmit({type:"POST",dataType:"html",beforeSerialize:function(e,t){o.element.trigger("cbajaxfield.save.serialize",[o,e,t])},beforeSubmit:function(e,t,i){var n=f.find(".cbAjaxForm").data("cbvalidate");if(n){if(!n.element.cbvalidate("validate")){return false}}o.element.append('<span class="cbSpinner fa fa-spinner fa-spin-fast"></span>');if(a=="inline"){f.addClass("hidden");o.element.removeClass("hidden");o.element.find(".cbAjaxValue").addClass("hidden")}else if(u){u.qtip("api").toggle(false);u=null}o.element.trigger("cbajaxfield.save.submit",[o,e,t,i])},error:function(e,t,i){o.element.removeClass("cbAjaxEditing");o.element.find(".cbSpinner").remove();if(a=="inline"){f.remove();o.element.find(".cbAjaxValue").removeClass("hidden")}else if(u){u.qtip("api").toggle(false);u=null}o.element.trigger("cbajaxfield.save.error",[o,e,t,i])},success:function(t,i,n){o.element.removeClass("cbAjaxEditing");o.element.find(".cbSpinner").remove();if(a=="inline"){f.remove();o.element.find(".cbAjaxValue").removeClass("hidden")}else if(u){u.qtip("api").toggle(false);u=null}var l=e("<div />").html(t);var s=r.call(l);o.element.find(".cbAjaxValue").html(l.html());c.call(l,s);if(e.fn.cbtooltip){l.find('.cbTooltip,[data-hascbtooltip="true"]').cbtooltip()}o.element.trigger("cbajaxfield.save.success",[o,t,i,n])}});return false});o.element.triggerHandler("cbajaxfield.edit.success",[o,i,l,s])}})}o.element.trigger("cbajaxfield.edit",[o,t])};o.element.on("click",".cbAjaxToggle",o.editHandler)}o.element.on("remove destroy.cbajaxfield",function(){o.element.cbajaxfield("destroy")});o.element.on("rebind.cbajaxfield",function(){o.element.cbajaxfield("rebind")});o.element.on("modified.cbajaxfield",function(e,t,i,n){if(i!=n){o.element.cbajaxfield("rebind")}});o.element.on("cloned.cbajaxfield",function(t,i){a.call(this,o);e(this).cbajaxfield(o.options)});o.element.trigger("cbajaxfield.init.after",[o]);o.element.data("cbajaxfield",o);t.push(o)})},rebind:function(){var t=e(this).data("cbajaxfield");if(!t){return this}t.element.cbajaxfield("destroy");t.element.cbajaxfield(t.options);return this},destroy:function(){var i=e(this).data("cbajaxfield");if(!i){return false}e.each(t,function(e,n){if(n.element==i.element){t.splice(e,1);return false}return true});a.call(i.element,i);i.element.trigger("cbajaxfield.destroyed",[i]);return true},instances:function(){return t}};function a(t){var i=this.jquery?this:e(this);i.off("destroy.cbajaxfield");i.off("rebind.cbajaxfield");i.off("cloned.cbajaxfield");i.off("modified.cbajaxfield");if(t.settings.mode=="update"){i.removeClass("cbAjaxUpdating");i.find(".cbAjaxUpdate").remove();if(t.timer){clearTimeout(t.timer)}e(t.settings.selectors).each(function(){l.call(this).off("keyup change",t.changeHandler)})}else{e(document).find(".cbAjaxCancel").click();i.find(".cbAjaxValue").removeClass("hidden");i.find(".cbSpinner").remove();i.off("click",".cbAjaxValue",t.editHandler)}i.removeData("cbajaxfield")}function l(){var t=this.jquery?this:e(this);var i=null;if(t.is("input")||t.is("select")||t.is("textarea")){i=t}else{i=t.find("input,select,textarea").first();if(i.is(":checkbox")||i.is(":radio")){i=t.find('input[name="'+i.attr("name")+'"]')}}return i}function s(){var t=this.jquery?this:e(this);var i=null;if(t.is("input")||t.is("select")||t.is("textarea")){if(t.is('input[type="checkbox"]')||t.is('input[type="radio"]')){i=[];t.each(function(){if(e(this).is(":checked")){i.push(e(this).val())}})}else if(t.is("select[multiple]")){i=t.val();if(i&&!e.isArray(i)){i=i.split(",")}}else{i=t.val()}}return i}function r(){var t=this.jquery?this:e(this);var i=t.find(".cbAjaxHeaders");if(!i.length){i=t.filter(".cbAjaxHeaders")}if(!i.length){return[]}var n=e("head");var a=[];var l=[];n.find("link").each(function(){var t=e(this).attr("href");if(typeof t!="undefined"){a.push(t)}});n.find("script").each(function(){var t=e(this).attr("src");if(typeof t!="undefined"){l.push(t)}});i.children("link").each(function(){var t=e(this).attr("href");if(typeof t!="undefined"&&a.indexOf(t)!==-1){e(this).remove()}});var s=[];i.children("script").each(function(){var t=e(this).attr("src");if(typeof t=="undefined"){s.push(this)}else{if(l.indexOf(t)===-1){s.push(this)}}e(this).remove()});return s}function c(t){if(!t.length){return}var i=this.jquery?this:e(this);var n=e('<div class="cbAjaxHeadersScripts" style="position: absolute; display: none; height: 0; width: 0; z-index: -999;" />');var a=function(i){var l=i+1;var s=e(this).attr("src");if(s){e.ajax({url:s,dataType:"script"}).always(function(){n.append('<script type="text/javascript" src="'+s+'"></script>');if(typeof t[l]!="undefined"){a.call(t[l],l)}})}else{n.append('<script type="text/javascript">'+e(this).text()+"</script>");if(typeof t[l]!="undefined"){a.call(t[l],l)}}};a.call(t[0],0);var l=i.find(".cbAjaxHeaders");if(!l.length){l=i.filter(".cbAjaxHeaders")}l.append(n)}e.fn.cbajaxfield=function(e){if(n[e]){return n[e].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof e==="object"||!e){return n.init.apply(this,arguments)}return this};e.fn.cbajaxfield.defaults={init:true,useData:true,mode:"inline",selectors:null,ignore:"a,video,audio,iframe",classes:null,url:null,post:null}})(jQuery);